<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP跨域详解 | Fanny</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="浏览器相关知识

为什么ajax的post请求会先触发options呢？

非简单请求的CORS（跨域）请求，会在正式通信之前，增加一次HTTP查询请求，称为预测请求（preflight）。因为你的请求发起域和到达域不在同一个域，所以浏览器会先发起一个options请求来询问到达域，允许那些请求方式、请求头、发起域等。

跨域资源共享CORS详解
 ...">
    
    <link rel="preload" href="/FannyBlog/assets/css/0.styles.21529ff0.css" as="style"><link rel="preload" href="/FannyBlog/assets/js/app.a39f2cab.js" as="script"><link rel="preload" href="/FannyBlog/assets/js/12.2adad98b.js" as="script"><link rel="preload" href="/FannyBlog/assets/js/4.afb47655.js" as="script"><link rel="preload" href="/FannyBlog/assets/js/10.f3addffd.js" as="script"><link rel="prefetch" href="/FannyBlog/assets/js/11.af7341fc.js"><link rel="prefetch" href="/FannyBlog/assets/js/13.a1fdcf46.js"><link rel="prefetch" href="/FannyBlog/assets/js/14.52487cd9.js"><link rel="prefetch" href="/FannyBlog/assets/js/15.17bc06b2.js"><link rel="prefetch" href="/FannyBlog/assets/js/16.37a90da4.js"><link rel="prefetch" href="/FannyBlog/assets/js/17.5ee2851b.js"><link rel="prefetch" href="/FannyBlog/assets/js/18.0c1a0a90.js"><link rel="prefetch" href="/FannyBlog/assets/js/19.27b9f03f.js"><link rel="prefetch" href="/FannyBlog/assets/js/20.91354e90.js"><link rel="prefetch" href="/FannyBlog/assets/js/21.45a42a68.js"><link rel="prefetch" href="/FannyBlog/assets/js/22.3c8a244d.js"><link rel="prefetch" href="/FannyBlog/assets/js/23.d6d20a1a.js"><link rel="prefetch" href="/FannyBlog/assets/js/24.26a5e1b3.js"><link rel="prefetch" href="/FannyBlog/assets/js/25.6890fcd1.js"><link rel="prefetch" href="/FannyBlog/assets/js/26.867b77a7.js"><link rel="prefetch" href="/FannyBlog/assets/js/27.118b4733.js"><link rel="prefetch" href="/FannyBlog/assets/js/28.29956b33.js"><link rel="prefetch" href="/FannyBlog/assets/js/29.f19a06a4.js"><link rel="prefetch" href="/FannyBlog/assets/js/3.63c2d876.js"><link rel="prefetch" href="/FannyBlog/assets/js/30.1e146699.js"><link rel="prefetch" href="/FannyBlog/assets/js/31.ee6a8139.js"><link rel="prefetch" href="/FannyBlog/assets/js/32.92896587.js"><link rel="prefetch" href="/FannyBlog/assets/js/33.bb7b024a.js"><link rel="prefetch" href="/FannyBlog/assets/js/34.20a53656.js"><link rel="prefetch" href="/FannyBlog/assets/js/35.d6f64fb4.js"><link rel="prefetch" href="/FannyBlog/assets/js/36.1be04dc2.js"><link rel="prefetch" href="/FannyBlog/assets/js/37.327b8b90.js"><link rel="prefetch" href="/FannyBlog/assets/js/38.05835afc.js"><link rel="prefetch" href="/FannyBlog/assets/js/39.0f694d10.js"><link rel="prefetch" href="/FannyBlog/assets/js/40.48873395.js"><link rel="prefetch" href="/FannyBlog/assets/js/41.2565bae0.js"><link rel="prefetch" href="/FannyBlog/assets/js/42.23a8359e.js"><link rel="prefetch" href="/FannyBlog/assets/js/43.f49b70ef.js"><link rel="prefetch" href="/FannyBlog/assets/js/44.c5cca5de.js"><link rel="prefetch" href="/FannyBlog/assets/js/45.9bd1d62b.js"><link rel="prefetch" href="/FannyBlog/assets/js/46.92661f23.js"><link rel="prefetch" href="/FannyBlog/assets/js/47.8fef021e.js"><link rel="prefetch" href="/FannyBlog/assets/js/48.b674f944.js"><link rel="prefetch" href="/FannyBlog/assets/js/49.7f392eeb.js"><link rel="prefetch" href="/FannyBlog/assets/js/5.01c595b2.js"><link rel="prefetch" href="/FannyBlog/assets/js/50.e6f0a438.js"><link rel="prefetch" href="/FannyBlog/assets/js/51.9f4e10f8.js"><link rel="prefetch" href="/FannyBlog/assets/js/6.7e5fbea0.js"><link rel="prefetch" href="/FannyBlog/assets/js/7.bbd61191.js"><link rel="prefetch" href="/FannyBlog/assets/js/8.f6b71c91.js"><link rel="prefetch" href="/FannyBlog/assets/js/9.08ba69c0.js"><link rel="prefetch" href="/FannyBlog/assets/js/vuejs-paginate.6d4c3ca3.js">
    <link rel="stylesheet" href="/FannyBlog/assets/css/0.styles.21529ff0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/FannyBlog/" class="nav-link home-link">Fanny </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/FannyBlog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/FannyBlog/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="https://github.com/FiggerDancer" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/FannyBlog/" class="nav-link mobile-home-link">Fanny </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/FannyBlog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/FannyBlog/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="https://github.com/FiggerDancer" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        HTTP跨域详解
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-8-4">
      2021-08-04
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/FannyBlog/tag/HTTP" data-v-42ccfcd5><span data-v-42ccfcd5>HTTP</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/FannyBlog/tag/学习笔记" data-v-42ccfcd5><span data-v-42ccfcd5>学习笔记</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/FannyBlog/tag/浏览器" data-v-42ccfcd5><span data-v-42ccfcd5>浏览器</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p><em>浏览器相关知识</em></p> <h2 id="为什么ajax的post请求会先触发options呢"><a href="#为什么ajax的post请求会先触发options呢" class="header-anchor">#</a> 为什么ajax的post请求会先触发options呢？</h2> <p>非简单请求的CORS（跨域）请求，会在正式通信之前，增加一次HTTP查询请求，称为<code>预测请求（preflight）</code>。因为你的请求发起域和到达域不在同一个域，所以浏览器会先发起一个options请求来询问到达域，允许那些请求方式、请求头、发起域等。</p> <h2 id="跨域资源共享cors详解"><a href="#跨域资源共享cors详解" class="header-anchor">#</a> 跨域资源共享CORS详解</h2> <p>CORS是一个W3C标准，全称是”跨域资源共享“（Cross-origin-resource-sharing)</p> <p>它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服AJAX只能同源使用的限制。</p> <p><img src="/FannyBlog/assets/img/1.7de72e0c.png" alt="跨域资源共享CORS详解"></p> <h3 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h3> <p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能。IE不能低于10</p> <p>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者而言，CORS通信与同源AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加头信息，有时会额外附加请求吗，但用户不会有感觉。</p> <p>因此实现CORS通信关键是服务器。只要服务器实现CORS接口，就可以跨源通信。</p> <h3 id="两种请求"><a href="#两种请求" class="header-anchor">#</a> 两种请求</h3> <p>浏览器将CORS请求分为两类：简单请求（simple request）和非简单请求（not-so-simple-request）</p> <p>同时满足以下两大条件，属于简单请求：</p> <blockquote><ol><li><p>请求方法为以下三种之一：</p> <ul><li>HEAD</li> <li>GET</li> <li>POST</li></ul></li> <li><p>HTTP的头信息不超出以下几种字段</p> <ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Last-Event-ID</li> <li>Content-Type: 只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</li></ul></li></ol></blockquote> <p>这是为了兼容表单（form），因为历史上表单一直可以发出跨域请求。AJAX的跨域设计就是，只要表单可以发，AJAX就可以直接发。</p> <p>凡是不同时满足上面两个条件，就属于非简单请求</p> <p>浏览器对这两种请求的处理，是不一样的</p> <h2 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h2> <h3 id="基本流程"><a href="#基本流程" class="header-anchor">#</a> 基本流程</h3> <p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息中，添加一个Origin字段。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>cors <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Host<span class="token operator">:</span> api<span class="token punctuation">.</span>alice<span class="token punctuation">.</span>com
Accept<span class="token operator">-</span>Language<span class="token operator">:</span> en<span class="token operator">-</span><span class="token constant">US</span>
Connection<span class="token operator">:</span> keep<span class="token operator">-</span>alive
User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span>
</code></pre></div><p>上面的头信息中，Origin字段用来说明，本次请求来自哪个源（协议+域名+端口）。服务器根据这个值，决定是否同意这次请求。</p> <p>如果Origin指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头信息没有包含Access-Control-Allow-Origin字段，就知道出错了，从而抛出错误，被XMLHttpRequest的onerror捕获。注意这种错误无法通过状态码识别，因为HTTP回应的状态码可能是200.如果Origin指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Credentials<span class="token operator">:</span> <span class="token boolean">true</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Expose<span class="token operator">-</span>Headers<span class="token operator">:</span> FooBar
Content<span class="token operator">-</span>Type<span class="token operator">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span>
</code></pre></div><p>上面的头信息中，有三个与CORS请求相关的字段，都以Access-Control开头</p> <table><thead><tr><th></th> <th></th></tr></thead> <tbody><tr><td>Access-Control-Allow-Origin</td> <td>该字段是必须的它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求</td></tr> <tr><td>Access-Control-Allow-Credentials</td> <td>该字段可选\n它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可</td></tr> <tr><td>Access-Control-Expose-Headers</td> <td>该字段可选\nCORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。上面的例子指定，getResponseHeader('FooBar')可以返回FooBar字段的值</td></tr></tbody></table> <h3 id="withcredentials-属性"><a href="#withcredentials-属性" class="header-anchor">#</a> withCredentials 属性</h3> <p>CORS请求默认不发送Cookie和HTTP认证信息。如果要把Cookie发到服务器，一方面要服务器同意，指定Access-Control-Allow-Credentials字段</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Credentials<span class="token operator">:</span> <span class="token boolean">true</span>
</code></pre></div><p>另一方面，开发者必须在AJAX请求中打开withCredentials属性</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>即使服务器同意发送Cookie，浏览器也不会发送。或者，服务器要求设置Cookie，浏览器也不会处理。</p> <p>但是，如果省略withCredentials设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭withCredentials</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre></div><p>需要注意的是，如果要发送Cookie，Access-Control-Allow-Origin就不能设为星号，必须制定明确的、与请求网页一致的域名。Cookie依然遵循同源政策，只有服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且跨源原网页代码中的document.cookie也无法读取服务器域名下的Cookie</p> <h3 id="非简单请求"><a href="#非简单请求" class="header-anchor">#</a> 非简单请求</h3> <h4 id="预检请求"><a href="#预检请求" class="header-anchor">#</a> 预检请求</h4> <p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法时PUT或DELETE，或者Content-Type字段类型是application/json</p> <p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为”预检“请求（preflight）</p> <p>浏览器先询问服务器，当前网页所在域名是否在在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只要得到肯定回复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://api.alice.com/cors'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'PUT'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Custom-Header'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Name'</span><span class="token punctuation">,</span> <span class="token string">'Ken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码中HTTP请求使用的方法为PUT，并且发送一个自定义头信息 X-Custom-Header</p> <p>浏览器发现，这是个非简单请求，就自动发出一个”预检“请求，要求服务器确认可以这样请求。下面是这个”预检“请求的HTTP头信息</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">OPTIONS</span> <span class="token operator">/</span>cors <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Method<span class="token operator">:</span> <span class="token constant">PUT</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Headers<span class="token operator">:</span> x<span class="token operator">-</span>custom<span class="token operator">-</span>header<span class="token punctuation">,</span>x<span class="token operator">-</span>name
Host<span class="token operator">:</span> api<span class="token punctuation">.</span>alice<span class="token punctuation">.</span>com
Accept<span class="token operator">-</span>Language<span class="token operator">:</span> en<span class="token operator">-</span><span class="token constant">US</span>
Connection<span class="token operator">:</span> keep<span class="token operator">-</span>alive
User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span><span class="token operator">...</span>
</code></pre></div><p>&quot;预检&quot;请求用的请求方法是OPTIONS，表示这个请求是用来询问的。头信息里面，关键字段是Origin，表示请求来自哪个源。</p> <p>除了Origin字段。”预检“请求的头信息包括两个特殊字段。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token number">1.</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Method
该字段是必须的，用来列出浏览器的<span class="token constant">CORS</span>请求会用到哪些<span class="token constant">HTTP</span>方法，上例是<span class="token constant">PUT</span>
<span class="token number">2.</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Headers
该字段是一个逗号分隔的字符串，指定浏览器<span class="token constant">CORS</span>请求会额外发送的头信息字段，上例是<span class="token constant">X</span><span class="token operator">-</span>Custom<span class="token operator">-</span>Header<span class="token punctuation">,</span><span class="token constant">X</span><span class="token operator">-</span>Name
</code></pre></div><h4 id="预检请求回应"><a href="#预检请求回应" class="header-anchor">#</a> 预检请求回应</h4> <p>服务器收到”预检“请求以后，检查Origin、Access-Control-Request-Method和Access-Control-Request-Headers字段后，允许跨源请求，可以做出回应</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">2000</span> <span class="token constant">OK</span>
Date<span class="token operator">:</span>Mon<span class="token punctuation">,</span> <span class="token number">01</span> Dec <span class="token number">2008</span> <span class="token number">01</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">39</span> <span class="token constant">GMT</span>
Server<span class="token operator">:</span> Apache<span class="token operator">/</span><span class="token number">2.0</span><span class="token number">.61</span> <span class="token punctuation">(</span>Unix<span class="token punctuation">)</span>

Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods<span class="token operator">:</span> <span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token constant">PUT</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers<span class="token operator">:</span> <span class="token constant">X</span><span class="token operator">-</span>Custom<span class="token operator">-</span>Header

Content<span class="token operator">-</span>Type<span class="token operator">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span>
Content<span class="token operator">-</span>Encoding<span class="token operator">:</span> gzip
Content<span class="token operator">-</span>Length<span class="token operator">:</span> <span class="token number">0</span>
Keep<span class="token operator">-</span>Alive<span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">100</span>
Connection<span class="token operator">:</span> Keep<span class="token operator">-</span>Alive
Content<span class="token operator">-</span>Type<span class="token operator">:</span> text<span class="token operator">/</span>plain
</code></pre></div><p>上面的HTTP回应中，关键的是Access-Control-Allow-Origin字段，表示[http://api.bob.com]可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> <span class="token operator">*</span>
</code></pre></div><p>如果服务器否定了”预检“请求，会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段。这时，浏览器就会认定，服务器不同意预检请求，因此触发了错误，被XMLHttpRequest对象的onerror回调函数捕获。打印信息如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>XMLHttpRequest cannot load http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>alice<span class="token punctuation">.</span>com
Origin http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com is 

not allowed by Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token punctuation">.</span>
</code></pre></div><p>服务器回应的其他CORS相关字段如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods<span class="token operator">:</span> <span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token constant">PUT</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers<span class="token operator">:</span> <span class="token constant">X</span><span class="token operator">-</span>Custom<span class="token operator">-</span>Header
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Credentials<span class="token operator">:</span> <span class="token boolean">true</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Max<span class="token operator">-</span>Age<span class="token operator">:</span> <span class="token number">1728000</span>
</code></pre></div><ol><li>Access-Control-Allow-Methods
该字段必须，它的值时逗号分隔的一个字符串，表明服务器支持的所有跨域请求方法。注意返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次“预检”请求。</li> <li>Access-Control-Allow-Headers
如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在“预检”中请求的字段。</li> <li>Access-Control-Allow-Credentials
该字段与简单请求时的含义相同</li> <li>Access-Control-Max-Age
该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（20天），到此期间，不用发出另一条预检请求</li></ol> <h4 id="浏览器的正常请求和回应"><a href="#浏览器的正常请求和回应" class="header-anchor">#</a> 浏览器的正常请求和回应</h4> <p>一旦服务器通过了预检请求，以后每次浏览器正常的CORS请求，都跟简单请求一样，会有一个Origin头信息字段。服务器的回应，也都会有一个Access-Control-Allow-Origin头信息字段</p> <p>下面是“预检”请求之后，浏览器的正常CORS请求</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">PUT</span> <span class="token operator">/</span>cors <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Host<span class="token operator">:</span> api<span class="token punctuation">.</span>alice<span class="token punctuation">.</span>com
<span class="token constant">X</span><span class="token operator">-</span>Custom<span class="token operator">-</span>Header<span class="token operator">:</span> value
Accept<span class="token operator">-</span>Language<span class="token operator">:</span> en<span class="token operator">-</span><span class="token constant">US</span>
Connection<span class="token operator">:</span> keep<span class="token operator">-</span>alive
User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span><span class="token operator">...</span>
</code></pre></div><p>上面头信息的Origin字段是浏览器自动添加的</p> <p>下面是服务器正常的回应</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>bob<span class="token punctuation">.</span>com
Content<span class="token operator">-</span>Type<span class="token operator">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span>
</code></pre></div><p>上面头信息中，Access-Control-Allow-Origin字段是每次回应必定包含的</p> <h4 id="cors与jsonp的比较"><a href="#cors与jsonp的比较" class="header-anchor">#</a> CORS与JSONP的比较</h4> <p>||jsonp|cors|
|请求类型|只支持GET请求|支持所有类型的HTTP请求|
|兼容性|支持老式浏览器，以及可以向不支持CORS的网站请求数据|只能被大多数现代浏览器支持|
|安全性|可能导致XSS问题|允许站点手动解析响应来确保安全|</p> <h2 id="跨域以及跨域的几种方式"><a href="#跨域以及跨域的几种方式" class="header-anchor">#</a> 跨域以及跨域的几种方式</h2> <p>讲解跨域之前我们先来看看什么是同源策略</p> <p><img src="/FannyBlog/assets/img/2.26cd5c2f.png" alt="跨域资源共享CORS详解"></p> <h3 id="什么是同源策略"><a href="#什么是同源策略" class="header-anchor">#</a> 什么是同源策略</h3> <p>通常来说，浏览器处于安全方面的考虑，浏览器遵循同源政策（<code>scheme（协议）</code>、<code>host（主机）</code>、<code>port（端口）</code>都相同则为同源），只允许与本域下的接口交互</p> <p>不同源的客户端脚本在没有明确授权的情况下，不许读写对方的资源，非同源站点有这样一些限制</p> <ul><li>不能读取和修改对方的DOM</li> <li>不读访问对方的Cookie、IndexDB和LocalStorage</li> <li>限制XMLHttpRequest请求</li></ul> <p>本域指的是</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">-</span>同协议：比如都是http或者https
<span class="token operator">-</span>同域名：比如都是http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>a和http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>b
<span class="token operator">-</span>同端名：比如都是<span class="token number">80</span>端口
</code></pre></div><p>同源</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>a<span class="token operator">/</span>b<span class="token punctuation">.</span>js 和 http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>index<span class="token punctuation">.</span>php
</code></pre></div><p>不同源：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>main<span class="token punctuation">.</span>js 和 https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>a<span class="token punctuation">.</span>php（协议不同）
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>main<span class="token punctuation">.</span>js 和 http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>bbs<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>a<span class="token punctuation">.</span><span class="token function">php</span><span class="token punctuation">(</span>域名不同，域名必须完全相同才可以<span class="token punctuation">)</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>main<span class="token punctuation">.</span>js 和 http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>a<span class="token punctuation">.</span><span class="token function">php</span><span class="token punctuation">(</span>端口不同，第一个是<span class="token number">80</span><span class="token punctuation">)</span>
</code></pre></div><p>需要注意的是：对于当前页面来说页面存放js文件的域不重要，重要的是加载该JS的页面所在的域</p> <p>当浏览器向目标URI发Ajax请求时，只要当前URL和目标URL不同源，则产生跨域，被称为跨域请求</p> <p>跨域请求的响应一般会被浏览器所拦截，注意，是被浏览器拦截，响应其实是成功到达客户端了。那这个拦截是如何发生呢？</p> <p>首先要知道，浏览器是多线程的，以Chrome为例，进程组成如下：</p> <p><img src="data:image/png;base64,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" alt="多线程"></p> <p><em>Webkit 渲染引擎</em>和<em>V8引擎</em>都在渲染进程中</p> <p>当<code>xhr.send</code>被调用，即Ajax请求准备发送时，其实还只是渲染进程的处理。为了防止黑客通过脚本触碰到系统资源，浏览器将每一个渲染进程装进了沙箱，并且为了防止CPU芯片一直存在的Spectre和Meltdown漏洞，采取了站点隔离的手段，给每一个不同的站点（一级域名不同）分配了沙箱，互不干扰。</p> <p>在沙箱当中的渲染进程是没办法发送网络请求的</p> <p>只能通过网络进程发送。这就涉及到了进程间通信（IPC，Inter Process Communication)了。接下来我们看看chromium当中进程间通信是如何完成的，在chromium源码中调用的顺序如下：</p> <p><img src="/FannyBlog/assets/img/4.4ae382c9.png" alt="进程通信"></p> <p>可能看了你会比较懵，如果你想深入了解可以去看看chromium最新源代码，<a href="https://www.yuque.com/r/goto?url=https%3A%2F%2Fchromium.googlesource.com%2Fchromium%2Fsrc%2F%2B%2Frefs%2Fheads%2Fmaster%2Fipc%2F" target="_blank" rel="noopener noreferrer">IPC源码地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 及 <a href="https://blog.csdn.net/Luoshengyang/article/details/47822689" target="_blank" rel="noopener noreferrer">Chromium IPC 源码解析文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>总的来说就是利用 Unix Domain Socket套接字，配合事件驱动的高性能网络并发库 libevent 完成进程的 IPC 过程。</p> <p>现在数据传递给浏览器主进程，主进程接收到后，才真正地发出相应的网络请求。</p> <p>在服务端处理完数据后，将响应返回，主进程检查到跨域，且没有cors（后面会详细说）响应头，将响应体全部丢掉，并不会发送给渲染进程。这就达到了拦截数据的目的。</p> <h3 id="跨域方式的演示"><a href="#跨域方式的演示" class="header-anchor">#</a> 跨域方式的演示</h3> <p>介绍跨域方式之前，先修改本机hosts文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> localhost
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> test<span class="token punctuation">.</span>com
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> a<span class="token punctuation">.</span>test<span class="token punctuation">.</span>com
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> b<span class="token punctuation">.</span>test<span class="token punctuation">.</span>com
</code></pre></div><p>这样本地地址就对应了不同的域</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <p>html中的script标签可以引入其他域下的js，比如引入线上的jquery库。利用这个特性，可实现跨域访问接口。不过需要后端支持。</p> <p>JSONP跨域方式是利用 <code>&lt;script&gt;</code> 标签的src属性可以跨域引用资源的特点，有些属性的标签还有 <code>&lt;img&gt;</code>、<code>&lt;iframe&gt;</code></p> <p>但是JSONP只支持GET方式，需要后端支持jsonp</p> <p>web页面中，通过script标签获取js代码可以进行跨域，我们可以动态创建script标签，设置src属性指向我们请求的资源url，放到head标签中。这样就可以把不同域的数据加载到本域名下，不过，需要后端支持jsonp。就是通过前端的url中的callback参数动态生成回调函数名，通过传参的形式执行获取到的数据，前端预定义好的函数就可以让传来的数据自动运行。</p> <h4 id="node-javascript-实现jsonp案例"><a href="#node-javascript-实现jsonp案例" class="header-anchor">#</a> Node+Javascript 实现JSONP案例</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>news<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>第11日前瞻：中国冲击4金 博尔特再战<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>男双力争会师决赛 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>女排将死磕巴西！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>change<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>换一组<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 首先，我们在前端要在调用资源的时候动态创建script标签，并设置src属性指向资源的URL地址，代码如下 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.change'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
    
    <span class="token comment">//callback=appendHtml是给后端资源打包数据用的参数，同时也是前端定义的回调函数</span>
    script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'//a.test.com:8080/getNews?callback=appendHtml'</span><span class="token punctuation">)</span>
    
    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span> <span class="token comment">//删除script标签是因为script标签插入页面的时候资源已经请求到了</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//定义获取资源后需要执行的回调函数</span>
  <span class="token keyword">function</span> <span class="token function">appendHtml</span><span class="token punctuation">(</span><span class="token parameter">news</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> news<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> html <span class="token operator">+=</span> <span class="token string">'&lt;li&gt;'</span> <span class="token operator">+</span> news<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'&lt;/li&gt;'</span> <span class="token punctuation">}</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.news'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端是把前端发送的URL地址拿到的数据以前端定义的回调函数（appendHtml）的参数的形式返回给前端，这样到前端就可以调用执行了：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> news <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;第11日前瞻：中国冲击4金 博尔特再战200米羽球&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;正直播柴飚/洪炜出战 男双力争会师决赛&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;女排将死磕巴西！郎平安排男陪练模仿对方核心&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;没有中国选手和巨星的110米栏 我们还看吗？&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;中英上演奥运金牌大战&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;博彩赔率挺中国夺回第二纽约时报：中国因对手服禁药而丢失的奖牌最多&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;最“出柜”奥运？同性之爱闪耀里约&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;下跪拜谢与洪荒之力一样 都是真情流露&quot;</span>
<span class="token punctuation">]</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> news<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>news<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>   <span class="token comment">//查询前端有没有传入回调函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>callback <span class="token operator">+</span> <span class="token string">'('</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//数据以函数参数的方式传给前端</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Server running at http://127.0.0.1:8888/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/FannyBlog/assets/img/5.ce3f6623.gif" alt="jsonp"></p> <p>封装XMLHttpRequest</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">$_ajax</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span>type <span class="token operator">=</span> request<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> send_data <span class="token operator">=</span><span class="token keyword">null</span>
    <span class="token keyword">var</span> data_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> request<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data_arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> data_str <span class="token operator">=</span> data_arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> xhr <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'Microsoft.XMLHTTP'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>url <span class="token operator">+=</span> <span class="token string">'?'</span> <span class="token operator">+</span> data_str
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span>
        send_data<span class="token operator">=</span>data_str
    <span class="token punctuation">}</span>
  
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>type<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>send_data<span class="token punctuation">)</span>  <span class="token comment">//参数的形式是:&quot;key=value&amp;id=123&quot;</span>

    xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'readystatechange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> sayHi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alert(a + b)&quot;</span><span class="token punctuation">)</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Word&quot;</span><span class="token punctuation">)</span>

<span class="token function">$_ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
        url<span class="token operator">:</span> <span class="token string">'jsonp.php'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
        username<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'123456789'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">$_ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'Post'</span><span class="token punctuation">,</span>
        url<span class="token operator">:</span> <span class="token string">'jsonp.php'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
        username<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'123456789'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">done</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>CORS全称跨域资源共享 (Cross-Origin Resource Sharing)</p> <p>CORS是一种ajax跨域请求资源的方式</p> <p>使用XMLHttpRequest发送请求时，浏览器发现请求不符合同源策略，会给该请求加一个请求头 <code>Origin</code></p> <p>后台进行一系列处理，如果确定接受请求，则在返回结果中加入一个响应头: Access-Control-Allow-Origin</p> <p>浏览器判断该响应头中是否包含 Origin 的值，如果有则浏览器会处理响应，我们就可以拿到响应数据，如果不包含浏览器直接驳回，这时我们无法拿到响应数据。所以 CORS 的表象是让你觉得它与同源的 ajax 请求没啥区别，代码完全一样</p> <h4 id="cors相关的http头如下"><a href="#cors相关的http头如下" class="header-anchor">#</a> CORS相关的HTTP头如下</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>请求头
Origin
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Method
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Request<span class="token operator">-</span>Headers
  
  
响应头
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Credentials
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Expose<span class="token operator">-</span>Headers
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Max<span class="token operator">-</span>Age
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers
</code></pre></div><p>首先js部分，发起Ajax请求（与同域相同）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.change'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'//a.test.com:8080/getNews'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">appendHtml</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>xhr <span class="token operator">=</span> xhr
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">appendHtml</span><span class="token punctuation">(</span><span class="token parameter">news</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> news<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    html <span class="token operator">+=</span> <span class="token string">'&lt;li&gt;'</span> <span class="token operator">+</span> news<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'&lt;/li&gt;'</span>
  <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.news'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html
<span class="token punctuation">}</span>
</code></pre></div><p>后端在向前端发送资源前，设置请求头 “Access-Control-Allow-Origin”</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> news <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;第11日前瞻：中国冲击4金 博尔特再战200米羽球&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;正直播柴飚/洪炜出战 男双力争会师决赛&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;女排将死磕巴西！郎平安排男陪练模仿对方核心&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;没有中国选手和巨星的110米栏 我们还看吗？&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;中英上演奥运金牌大战&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;博彩赔率挺中国夺回第二纽约时报：中国因对手服禁药而丢失的奖牌最多&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;最“出柜”奥运？同性之爱闪耀里约&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;下跪拜谢与洪荒之力一样 都是真情流露&quot;</span>
<span class="token punctuation">]</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> news<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>news<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;//test.com:8080&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// //test.com:8080表示只有//test.com:8080下发起请求才可以调用本域下的资源</span>
<span class="token comment">//res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);   //*表示任何域下发起请求都可以调用本域下的资源</span>
res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="iframe-降域"><a href="#iframe-降域" class="header-anchor">#</a> iframe 降域</h3> <p>降域是对于iframe元素而言</p> <p>一般来说域名为 [http://a.test.com/a] A的网页以iframe的形式嵌套一个域名为 [http://b.test.com/b] B的网页中，浏览器发现该请求不符合同源策略，正常情况下不能进行跨域访问</p> <p>但是当我们在两个页面中分别设置 <code>document.domain = '相同域名'</code> 的时候（注意观察这个方法有一个限制就是域名中必有相同部分），A页面就可以访问到B页面的资源了</p> <p>A页面</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.ct</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 910px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.main</span> <span class="token punctuation">{</span> <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.main input</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.iframe</span> <span class="token punctuation">{</span> <span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">iframe</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px dashed #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ct<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>使用 iframe降域 实现跨域<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(A) 父页面<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iframe-test<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://127.0.0.1:5500/b.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scrolling</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">//URL: http://127.0.0.1:5500/a.html</span>
  document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.main input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// window.frames[&quot;iframe-test&quot;].document.querySelector('input').value = this.value; //❌</span>
    <span class="token comment">// window.frames[0].document.querySelector('input').value = this.value; //✅</span>
    <span class="token comment">// document.getElementById(&quot;iframe-test&quot;).contentDocument.querySelector('input').value = this.value; //✅</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;iframe-test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">//✅</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>B页面</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">html, body</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(B) 子页面<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// URL: http://127.0.0.1:5500/b.html</span>
  document<span class="token punctuation">.</span>domain <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>通过a.test.com/a.html 访问 b.test.com/b.html，实现了跨域访问，效果如下:</p> <p><img src="/FannyBlog/assets/img/6.b8d86eac.gif" alt="iframe"></p> <h3 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage()</h3> <p>window.postMessage()是HTML5的新方法，可以使用它来向其它的window对象发送数据，无论这个window对象是属于同源或不同源，IE8+支持</p> <p>postMessage(data, origin)方法接收两个参数</p> <ul><li><code>data</code> 要传递的数据。html5规范中提到该参数可以是JavaScript的任意基本类型或可复制的对象，然而并不是所有浏览器都做到了这点儿，部分浏览器只能处理字符串参数，所以我们在传递参数的时候需要使用JSON.stringify()方法对对象参数序列化，在低版本IE中引用json2.js可以实现类似效果。</li> <li><code>origin</code> 字符串参数，用来限定接收消息的那个window对象所在的域，如果不想限定域，可以使用通配符 * ，这样可以传递给任意窗口，如果要指定和当前窗口同源的话设置为&quot;/&quot;</li></ul> <p>同样以上面将域的例子来说明postMessage()的原理（A页面中嵌套了一个B页面）</p> <p>那么我们可以在A页面中通过postMessage()方法向跨域的B页面传递数据</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">.ct</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 910px<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.main</span> <span class="token punctuation">{</span> <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.main input</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.iframe</span> <span class="token punctuation">{</span> <span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">iframe</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px dashed #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ct<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>使用 postMessage() 实现跨域<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(A) 父页面<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://127.0.0.1:5500/b.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.main input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>data
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么，我们怎么在B页面上接收A页面传递过来的数据呢，我们只要在B页面监听window的message事件就可以，消息内容储存在该事件对象的data属性中</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(B) 父页面<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>data
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>同样，如果想要在B页面发送数据，A页面接受数据，只要在B页面使用postMessage()方法，然后在A页面监听window的message事件即可。</p> <p>最终页面得到的效果如下:</p> <p><img src="/FannyBlog/assets/img/7.3562131c.gif" alt="postMessage"></p> <h3 id="websocket"><a href="#websocket" class="header-anchor">#</a> websocket</h3> <h3 id="nginx-代理"><a href="#nginx-代理" class="header-anchor">#</a> nginx 代理</h3> <p>Nginx 是一种高性能的反向代理服务器，可以用来轻松解决跨域问题。</p> <p>what？反向代理？我给你看一张图你就懂了。</p> <p><img src="/FannyBlog/assets/img/8.199269e3.png" alt="nginx"></p> <p>正向代理帮助客户端访问客户端自己访问不到的服务器，然后将结果返回给客户端。</p> <p>反向代理拿到客户端的请求，将请求转发给其他的服务器，主要的场景是维持服务器集群的负载均衡，换句话说，反向代理帮其它的服务器拿到请求，然后选择一个合适的服务器，将请求转交给它。</p> <p>因此，两者的区别就很明显了，正向代理服务器是帮客户端做事情，而反向代理服务器是帮其它的服务器做事情。</p> <p>好了，那 Nginx 是如何来解决跨域的呢？</p> <p>比如说现在客户端的域名为client.com，服务器的域名为server.com，客户端向服务器发送 Ajax 请求，当然会跨域了，那这个时候让 Nginx 登场了，通过下面这个配置:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>server <span class="token punctuation">{</span>
  listen  <span class="token number">80</span><span class="token punctuation">;</span>
  server_name  client<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  location <span class="token operator">/</span>api <span class="token punctuation">{</span>
    proxy_pass server<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nginx 相当于起了一个跳板机，这个跳板机的域名也是client.com，让客户端首先访问 client.com/api，这当然没有跨域，然后 Nginx 服务器作为反向代理，将请求转发给server.com，当响应返回时又将响应给到客户端，这就完成整个跨域请求的过程。</p> <p>其实还有一些不太常用的方式，大家了解即可，比如 <code>postMessage</code>，当然 <code>WebSocket</code> 也是一种方式，但是已经不属于 HTTP 的范畴，另外一些奇技淫巧就不建议大家去死记硬背了，一方面从来不用，名字都难得记住，另一方面临时背下来，面试官也不会对你印象加分，因为看得出来是背的。当然没有背并不代表减分，把跨域原理和前面三种主要的跨域方式理解清楚，经得起更深一步的推敲，反而会让别人觉得你是一个靠谱的人。</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#为什么ajax的post请求会先触发options呢" title="为什么ajax的post请求会先触发options呢？">为什么ajax的post请求会先触发options呢？</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#跨域资源共享cors详解" title="跨域资源共享CORS详解">跨域资源共享CORS详解</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#简介" title="简介">简介</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#两种请求" title="两种请求">两种请求</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#简单请求" title="简单请求">简单请求</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#基本流程" title="基本流程">基本流程</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#withcredentials-属性" title="withCredentials 属性">withCredentials 属性</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#非简单请求" title="非简单请求">非简单请求</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#跨域以及跨域的几种方式" title="跨域以及跨域的几种方式">跨域以及跨域的几种方式</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#什么是同源策略" title="什么是同源策略">什么是同源策略</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#跨域方式的演示" title="跨域方式的演示">跨域方式的演示</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#jsonp" title="JSONP">JSONP</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cors" title="CORS">CORS</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#iframe-降域" title="iframe 降域">iframe 降域</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#postmessage" title="postMessage()">postMessage()</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#websocket" title="websocket">websocket</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#nginx-代理" title="nginx 代理">nginx 代理</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/FiggerDancer" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>Fanny Li © 2019</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/FannyBlog/assets/js/app.a39f2cab.js" defer></script><script src="/FannyBlog/assets/js/12.2adad98b.js" defer></script><script src="/FannyBlog/assets/js/4.afb47655.js" defer></script><script src="/FannyBlog/assets/js/10.f3addffd.js" defer></script>
  </body>
</html>
